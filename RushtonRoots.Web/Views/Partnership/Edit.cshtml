@model RushtonRoots.Domain.UI.Requests.UpdatePartnershipRequest
@{
    ViewData["Title"] = "Edit Partnership";
    var people = ViewBag.People as IEnumerable<RushtonRoots.Domain.UI.Models.PersonViewModel>;
}

<div class="container mt-4">
    <h2>Edit Partnership</h2>

    <!-- Anti-forgery token for secure form submission -->
    @Html.AntiForgeryToken()

    <!-- Angular Component -->
    <app-partnership-form
        id="partnershipForm"
        available-people='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            (people ?? Enumerable.Empty<RushtonRoots.Domain.UI.Models.PersonViewModel>())
            .Select(p => new {
                id = p.Id,
                name = p.FullName,
                photoUrl = p.PhotoUrl,
                birthDate = p.DateOfBirth?.ToString("o"),
                deathDate = p.DateOfDeath?.ToString("o"),
                lifeSpan = p.DateOfBirth.HasValue && p.DateOfDeath.HasValue 
                    ? $"{p.DateOfBirth.Value.Year}-{p.DateOfDeath.Value.Year}"
                    : p.DateOfBirth.HasValue 
                    ? $"{p.DateOfBirth.Value.Year}-Present"
                    : ""
            })
        ))'
        partnership='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(new {
            id = Model.Id,
            personAId = Model.PersonAId,
            personBId = Model.PersonBId,
            partnershipType = Model.PartnershipType?.ToLower() ?? "married",
            startDate = Model.StartDate?.ToString("o"),
            endDate = Model.EndDate?.ToString("o"),
            location = "",
            notes = ""
        }))'>
    </app-partnership-form>

    <!-- Fallback for browsers without JavaScript -->
    <noscript>
        <div class="alert alert-warning">
            <strong>JavaScript Required:</strong> This form requires JavaScript to function properly.
            Please enable JavaScript in your browser or use the simplified form below.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    
                    <div class="form-group mb-3">
                        <label asp-for="PersonAId" class="control-label">First Person</label>
                        <select asp-for="PersonAId" class="form-control">
                            <option value="">-- Select Person --</option>
                            @if (people != null)
                            {
                                foreach (var person in people)
                                {
                                    <option value="@person.Id" selected="@(person.Id == Model.PersonAId)">@person.FullName</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="PersonAId" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="PersonBId" class="control-label">Second Person</label>
                        <select asp-for="PersonBId" class="form-control">
                            <option value="">-- Select Person --</option>
                            @if (people != null)
                            {
                                foreach (var person in people)
                                {
                                    <option value="@person.Id" selected="@(person.Id == Model.PersonBId)">@person.FullName</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="PersonBId" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="PartnershipType" class="control-label">Partnership Type</label>
                        <select asp-for="PartnershipType" class="form-control">
                            <option value="">-- Select Type --</option>
                            <option value="Married">Married</option>
                            <option value="Partnered">Partnered</option>
                            <option value="Engaged">Engaged</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Separated">Separated</option>
                        </select>
                        <span asp-validation-for="PartnershipType" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="StartDate" class="control-label">Start Date</label>
                        <input asp-for="StartDate" type="date" class="form-control" />
                        <span asp-validation-for="StartDate" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="EndDate" class="control-label">End Date</label>
                        <input asp-for="EndDate" type="date" class="form-control" />
                        <span asp-validation-for="EndDate" class="text-danger"></span>
                    </div>

                    <div class="form-group mt-4">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </noscript>
</div>

@section Scripts {
    <script>
        (function() {
            const partnershipForm = document.getElementById('partnershipForm');
            
            if (partnershipForm) {
                // Handle form submission
                partnershipForm.addEventListener('submitted', function(event) {
                    const formData = event.detail;
                    
                    // Prepare request data
                    const requestData = {
                        Id: formData.id,
                        PersonAId: formData.personAId,
                        PersonBId: formData.personBId,
                        PartnershipType: formData.partnershipType,
                        StartDate: formData.startDate ? new Date(formData.startDate).toISOString() : null,
                        EndDate: formData.endDate ? new Date(formData.endDate).toISOString() : null,
                        Location: formData.location || '',
                        Notes: formData.notes || ''
                    };
                    
                    // Get anti-forgery token
                    const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                    const token = tokenElement ? tokenElement.value : '';
                    
                    // Submit to backend
                    fetch('@Url.Action("Edit", "Partnership")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Failed to update partnership');
                        }
                    })
                    .then(data => {
                        // Redirect to partnership details
                        window.location.href = '@Url.Action("Details", "Partnership")/' + formData.id;
                    })
                    .catch(error => {
                        console.error('Error updating partnership:', error);
                        alert('An error occurred while updating the partnership. Please try again.');
                    });
                });
                
                // Handle form cancellation
                partnershipForm.addEventListener('cancelled', function() {
                    window.location.href = '@Url.Action("Details", "Partnership")/' + @Model.Id;
                });
            }
        })();
    </script>
}
