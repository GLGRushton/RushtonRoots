@model RushtonRoots.Domain.UI.Models.ParentChildViewModel
@using System.Text.Json
@using RushtonRoots.Domain.Database
@{
    ViewData["Title"] = "Relationship Details";
    
    // Transform relationship type to include icon and color
    var relationshipTypeConfig = Model.RelationshipType.ToLower() switch
    {
        "biological" => new { Display = "Biological", Icon = "bloodtype", Color = "primary", Description = "Biological parent-child relationship" },
        "adopted" => new { Display = "Adopted", Icon = "volunteer_activism", Color = "accent", Description = "Legal adoption" },
        "step" => new { Display = "Step", Icon = "family_restroom", Color = "accent", Description = "Step-parent relationship" },
        "guardian" => new { Display = "Guardian", Icon = "shield", Color = "accent", Description = "Legal guardian" },
        "foster" => new { Display = "Foster", Icon = "home", Color = "accent", Description = "Foster care relationship" },
        _ => new { Display = "Unknown", Icon = "help_outline", Color = "warn", Description = "Relationship type unknown" }
    };
    
    // Build relationship details object
    var relationshipDetails = new
    {
        id = Model.Id,
        parentPersonId = Model.ParentPersonId,
        childPersonId = Model.ChildPersonId,
        parentName = Model.ParentName,
        childName = Model.ChildName,
        parentPhotoUrl = Model.ParentPhotoUrl,
        childPhotoUrl = Model.ChildPhotoUrl,
        parentBirthDate = Model.ParentBirthDate,
        parentDeathDate = Model.ParentDeathDate,
        childBirthDate = Model.ChildBirthDate,
        childDeathDate = Model.ChildDeathDate,
        relationshipType = Model.RelationshipType,
        relationshipTypeDisplay = relationshipTypeConfig.Display,
        relationshipTypeIcon = relationshipTypeConfig.Icon,
        relationshipTypeColor = relationshipTypeConfig.Color,
        relationshipTypeDescription = relationshipTypeConfig.Description,
        isVerified = Model.IsVerified,
        verifiedDate = Model.VerifiedDate,
        verifiedBy = Model.VerifiedBy,
        confidence = Model.ConfidenceScore,
        notes = Model.Notes,
        createdDateTime = Model.CreatedDateTime,
        updatedDateTime = Model.UpdatedDateTime
    };
    
    var relationshipJson = JsonSerializer.Serialize(relationshipDetails);
    
    // Evidence, events, grandparents, and siblings will be fetched via JavaScript from the API
    var evidenceJson = "[]"; // Will be populated via API call
    var eventsJson = "[]"; // Will be populated via API call
    var grandparentsJson = "[]"; // Will be populated via API call
    var siblingsJson = "[]"; // Will be populated via API call
    
    var canEdit = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    var canDelete = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    var canVerify = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
}

<div class="container mt-4">
    <h2>Parent-Child Relationship Details</h2>
    <hr />

    <!-- Angular Element -->
    <app-parent-child-details
        relationship='@Html.Raw(relationshipJson)'
        evidence='@evidenceJson'
        events='@Html.Raw(eventsJson)'
        grandparents='@grandparentsJson'
        siblings='@siblingsJson'
        can-edit="@(canEdit ? "true" : "false")"
        can-delete="@(canDelete ? "true" : "false")"
        can-verify="@(canVerify && !Model.IsVerified ? "true" : "false")"
        initial-tab="0">
    </app-parent-child-details>

    <!-- Fallback content for when Angular fails to load -->
    <noscript>
        <div class="alert alert-warning">
            <strong>JavaScript Required:</strong> This page requires JavaScript to be enabled for the best experience.
        </div>
        
        <dl class="row">
            <dt class="col-sm-3">Parent</dt>
            <dd class="col-sm-9">@Model.ParentName</dd>

            <dt class="col-sm-3">Child</dt>
            <dd class="col-sm-9">@Model.ChildName</dd>

            <dt class="col-sm-3">Relationship Type</dt>
            <dd class="col-sm-9">@Model.RelationshipType</dd>

            <dt class="col-sm-3">Created</dt>
            <dd class="col-sm-9">@Model.CreatedDateTime.ToString("MM/dd/yyyy hh:mm tt")</dd>

            <dt class="col-sm-3">Last Updated</dt>
            <dd class="col-sm-9">@Model.UpdatedDateTime.ToString("MM/dd/yyyy hh:mm tt")</dd>
        </dl>

        <div>
            @if (canEdit)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edit</a>
            }
            @if (canDelete)
            {
                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Delete</a>
            }
            <a asp-action="Index" class="btn btn-secondary">Back to List</a>
        </div>
    </noscript>
</div>

@section Scripts {
    <script>
        // Fetch additional data from APIs when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const detailsComponent = document.querySelector('app-parent-child-details');
            const relationshipId = @Model.Id;
            
            if (detailsComponent) {
                // Fetch evidence (sources/citations)
                fetch('/api/parentchild/' + relationshipId + '/evidence')
                    .then(response => response.ok ? response.json() : [])
                    .then(data => {
                        console.log('Evidence loaded:', data);
                        detailsComponent.setAttribute('evidence', JSON.stringify(data));
                    })
                    .catch(error => {
                        console.error('Error loading evidence:', error);
                    });
                
                // Fetch related events
                fetch('/api/parentchild/' + relationshipId + '/events')
                    .then(response => response.ok ? response.json() : [])
                    .then(data => {
                        console.log('Events loaded:', data);
                        detailsComponent.setAttribute('events', JSON.stringify(data));
                    })
                    .catch(error => {
                        console.error('Error loading events:', error);
                    });
                
                // Fetch grandparents
                fetch('/api/parentchild/' + relationshipId + '/grandparents')
                    .then(response => response.ok ? response.json() : [])
                    .then(data => {
                        console.log('Grandparents loaded:', data);
                        detailsComponent.setAttribute('grandparents', JSON.stringify(data));
                    })
                    .catch(error => {
                        console.error('Error loading grandparents:', error);
                    });
                
                // Fetch siblings
                fetch('/api/parentchild/' + relationshipId + '/siblings')
                    .then(response => response.ok ? response.json() : [])
                    .then(data => {
                        console.log('Siblings loaded:', data);
                        detailsComponent.setAttribute('siblings', JSON.stringify(data));
                    })
                    .catch(error => {
                        console.error('Error loading siblings:', error);
                    });
                
                // Handle edit click
                detailsComponent.addEventListener('editClicked', function(event) {
                    const relationshipId = event.detail;
                    window.location.href = '@Url.Action("Edit", "ParentChild")/' + relationshipId;
                });
                
                // Handle delete click
                detailsComponent.addEventListener('deleteClicked', function(event) {
                    const relationshipId = event.detail;
                    window.location.href = '@Url.Action("Delete", "ParentChild")/' + relationshipId;
                });
                
                // Handle verify click
                detailsComponent.addEventListener('verifyClicked', function(event) {
                    const relationshipId = event.detail;
                    
                    if (!confirm('Are you sure you want to verify this parent-child relationship? This action indicates you have reviewed and confirmed its accuracy.')) {
                        return;
                    }
                    
                    // Get anti-forgery token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Call verification endpoint
                    fetch('/api/parentchild/' + relationshipId + '/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            throw new Error('Failed to verify relationship');
                        }
                    })
                    .then(data => {
                        alert('Relationship verified successfully!');
                        // Reload page to show updated verification status
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error verifying relationship:', error);
                        alert('Failed to verify relationship. Please try again.');
                    });
                });
                
                // Handle person click - navigate to person details
                detailsComponent.addEventListener('personClicked', function(event) {
                    const personId = event.detail;
                    window.location.href = '@Url.Action("Details", "Person")/' + personId;
                });
                
                // Handle note update
                detailsComponent.addEventListener('noteUpdated', function(event) {
                    const notes = event.detail;
                    
                    // Get anti-forgery token
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
                    
                    // Call notes update endpoint
                    fetch('/api/parentchild/' + relationshipId + '/notes', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ notes: notes })
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        } else if (response.status === 400) {
                            return response.json().then(data => {
                                throw new Error(data.message || 'Invalid notes input');
                            });
                        } else {
                            throw new Error('Failed to update notes');
                        }
                    })
                    .then(data => {
                        alert('Notes updated successfully!');
                        console.log('Updated relationship:', data);
                    })
                    .catch(error => {
                        console.error('Error updating notes:', error);
                        alert('Failed to update notes: ' + error.message);
                    });
                });
            }
        });
    </script>
    
    <!-- Anti-forgery token for AJAX requests -->
    @Html.AntiForgeryToken()
}
