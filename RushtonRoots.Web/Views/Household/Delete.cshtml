@model RushtonRoots.Domain.UI.Models.HouseholdViewModel
@using RushtonRoots.Domain.UI.Models
@{
    ViewData["Title"] = "Delete Household";
    
    // Get delete impact from ViewBag
    var deleteImpact = ViewBag.DeleteImpact as HouseholdDeleteImpact;
    
    // Build related data JSON for Angular component with real data
    var relatedData = new {
        members = deleteImpact?.MemberCount ?? Model.MemberCount,
        events = deleteImpact?.EventCount ?? 0,
        sharedMedia = deleteImpact?.PhotoCount ?? 0,
        documents = deleteImpact?.DocumentCount ?? 0,
        permissions = deleteImpact?.RelationshipCount ?? 0
    };
}

<div class="container mt-4">
    <h2>Delete Household</h2>
    
    <!-- Angular Element Component -->
    <app-household-delete-dialog
        household-id="@Model.Id"
        household-name="@Model.HouseholdName"
        anchor-person-name="@Model.AnchorPersonName"
        anchor-person-id="@(Model.AnchorPersonId?.ToString() ?? "")"
        member-count="@Model.MemberCount"
        created-date="@Model.CreatedDateTime.ToString("o")"
        is-admin="@User.IsInRole("Admin").ToString().ToLower()"
        related-data='@System.Text.Json.JsonSerializer.Serialize(relatedData)'>
    </app-household-delete-dialog>

    <!-- JavaScript to handle component events -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const deleteDialog = document.querySelector('app-household-delete-dialog');
            
            if (deleteDialog) {
                // Listen for deleteConfirmed event from Angular component
                deleteDialog.addEventListener('deleteConfirmed', function(event) {
                    const options = event.detail;
                    console.log('Delete confirmed:', options);
                    
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('Id', '@Model.Id');
                    formData.append('DeleteType', options.deleteType);
                    formData.append('NotifyMembers', options.notifyMembers);
                    formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
                    
                    // Submit delete request to server
                    fetch('@Url.Action("Delete", "Household")', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Redirect to index on success
                            window.location.href = '@Url.Action("Index", "Household")';
                        } else {
                            alert('Error deleting household. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error deleting household. Please try again.');
                    });
                });
                
                // Listen for deleteCancelled event from Angular component
                deleteDialog.addEventListener('deleteCancelled', function(event) {
                    console.log('Delete cancelled');
                    // Redirect back to index
                    window.location.href = '@Url.Action("Index", "Household")';
                });
            }
        });
    </script>
    
    <!-- Anti-forgery token for secure POST -->
    @Html.AntiForgeryToken()
    
    <!-- Fallback content for browsers with JavaScript disabled -->
    <noscript>
        <div class="alert alert-danger">
            <h4>Are you sure you want to delete this household?</h4>
            <p>This action cannot be undone.</p>
        </div>

        <div class="card">
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Household Name</dt>
                    <dd class="col-sm-9">@Model.HouseholdName</dd>

                    <dt class="col-sm-3">Anchor Person</dt>
                    <dd class="col-sm-9">@Model.AnchorPersonName</dd>

                    <dt class="col-sm-3">Members</dt>
                    <dd class="col-sm-9">@Model.MemberCount @(Model.MemberCount == 1 ? "member" : "members")</dd>

                    <dt class="col-sm-3">Created</dt>
                    <dd class="col-sm-9">@Model.CreatedDateTime.ToString("MMMM dd, yyyy")</dd>
                </dl>
            </div>
        </div>

        <form asp-action="Delete" method="post" class="mt-3">
            <input type="hidden" asp-for="Id" />
            <button type="submit" class="btn btn-danger">Delete</button>
            <a asp-action="Index" class="btn btn-secondary">Cancel</a>
        </form>
    </noscript>
</div>
