@model RushtonRoots.Domain.UI.Models.HouseholdViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Household Details";
    
    var canEdit = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    var canDelete = User.IsInRole("Admin");
    var canManageMembers = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    var canEditSettings = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    
    // Transform HouseholdViewModel to HouseholdDetails interface format
    var householdDetails = new {
        id = Model.Id,
        householdName = Model.HouseholdName,
        description = (string?)null, // Not available in current ViewModel
        anchorPersonId = Model.AnchorPersonId,
        anchorPersonName = Model.AnchorPersonName,
        anchorPersonPhotoUrl = (string?)null, // Not available in current ViewModel
        memberCount = Model.MemberCount,
        createdDateTime = Model.CreatedDateTime.ToString("o"),
        updatedDateTime = Model.UpdatedDateTime.ToString("o"),
        createdByUserId = (int?)null, // Not available in current ViewModel
        createdByUserName = (string?)null, // Not available in current ViewModel
        privacy = "FamilyOnly", // Default - not available in current ViewModel
        allowMemberInvites = true // Default - not available in current ViewModel
    };
    
    var householdJson = JsonSerializer.Serialize(householdDetails, new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase });
}

<!-- Angular Household Details Component -->
<app-household-details 
    household='@Html.Raw(householdJson)'
    members='[]'
    activity-events='[]'
    can-edit='@canEdit.ToString().ToLower()'
    can-delete='@canDelete.ToString().ToLower()'
    can-manage-members='@canManageMembers.ToString().ToLower()'
    can-edit-settings='@canEditSettings.ToString().ToLower()'>
</app-household-details>

<script>
    (function() {
        const householdDetailsElement = document.querySelector('app-household-details');
        
        if (!householdDetailsElement) {
            console.error('app-household-details element not found');
            return;
        }
        
        // Handle edit button click
        householdDetailsElement.addEventListener('editClicked', function(event) {
            const householdId = event.detail;
            window.location.href = '@Url.Action("Edit", "Household")/' + householdId;
        });
        
        // Handle delete button click
        householdDetailsElement.addEventListener('deleteClicked', function(event) {
            const householdId = event.detail;
            window.location.href = '@Url.Action("Delete", "Household")/' + householdId;
        });
        
        // Handle anchor person click
        householdDetailsElement.addEventListener('anchorPersonClicked', function(event) {
            const personId = event.detail;
            window.location.href = '@Url.Action("Details", "Person")/' + personId;
        });
        
        // Handle member action clicks
        householdDetailsElement.addEventListener('memberActionClicked', function(event) {
            const action = event.detail;
            
            switch (action.action) {
                case 'view-profile':
                    window.location.href = '@Url.Action("Details", "Person")/' + action.memberPersonId;
                    break;
                case 'edit':
                    window.location.href = '@Url.Action("Edit", "Person")/' + action.memberPersonId;
                    break;
                case 'remove':
                    handleRemoveMember(action);
                    break;
                case 'change-role':
                    handleChangeRole(action);
                    break;
                case 'resend-invite':
                    handleResendInvite(action);
                    break;
                default:
                    console.warn('Unknown member action:', action.action);
            }
        });
        
        // Handle invite member button click
        householdDetailsElement.addEventListener('inviteMemberClicked', function(event) {
            // TODO: Implement member invitation modal/page
            console.log('Invite new member to household');
            alert('Member invitation feature coming soon!');
        });
        
        // Handle settings update
        householdDetailsElement.addEventListener('settingsUpdated', function(event) {
            const settings = event.detail;
            handleUpdateSettings(settings);
        });
        
        // Helper function to get CSRF token
        function getAntiForgeryToken() {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : '';
        }
        
        // Helper function to show success message
        function showSuccess(message) {
            alert(message); // TODO: Replace with toast notification
        }
        
        // Helper function to show error message
        function showError(message) {
            alert('Error: ' + message); // TODO: Replace with toast notification
        }
        
        // Handle remove member
        function handleRemoveMember(action) {
            if (!confirm('Are you sure you want to remove this member from the household?')) {
                return;
            }
            
            // Note: The API expects userId (string), but we're getting personId from the Angular component
            // For now, we'll use the personId as userId since the backend will try to resolve it
            const userId = action.memberId.toString();
            
            fetch('/api/household/@Model.Id/member/' + encodeURIComponent(userId), {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                }
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Member removed successfully!');
                    // Reload the page to reflect changes
                    window.location.reload();
                } else if (response.status === 404) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Member not found');
                    });
                } else if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Invalid request');
                    });
                } else {
                    throw new Error('Failed to remove member');
                }
            })
            .catch(error => {
                console.error('Error removing member:', error);
                showError(error.message || 'An error occurred while removing the member.');
            });
        }
        
        // Handle change role
        function handleChangeRole(action) {
            const currentRole = action.data?.currentRole || 'Member';
            const roles = ['ADMIN', 'EDITOR'];
            
            // Simple role selection dialog
            const newRole = prompt('Select new role:\n1 = ADMIN (can manage members and edit household)\n2 = EDITOR (can edit household content)\n\nCurrent role: ' + currentRole + '\n\nEnter 1 or 2:');
            
            if (newRole === null || newRole === '') {
                return; // User cancelled
            }
            
            const selectedRole = newRole === '1' ? 'ADMIN' : newRole === '2' ? 'EDITOR' : null;
            
            if (!selectedRole) {
                showError('Invalid role selection. Please enter 1 or 2.');
                return;
            }
            
            const userId = action.memberId.toString();
            
            fetch('/api/household/@Model.Id/member/' + encodeURIComponent(userId) + '/role', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                },
                body: JSON.stringify({
                    role: selectedRole
                })
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Member role updated successfully to ' + selectedRole + '!');
                    // Reload the page to reflect changes
                    window.location.reload();
                } else if (response.status === 404) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Member not found');
                    });
                } else if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Invalid request');
                    });
                } else {
                    throw new Error('Failed to update member role');
                }
            })
            .catch(error => {
                console.error('Error updating member role:', error);
                showError(error.message || 'An error occurred while updating the member role.');
            });
        }
        
        // Handle resend invite
        function handleResendInvite(action) {
            const userId = action.memberId.toString();
            
            fetch('/api/household/@Model.Id/member/' + encodeURIComponent(userId) + '/resend-invite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                }
            })
            .then(response => {
                if (response.ok) {
                    showSuccess('Invitation resent successfully!');
                } else if (response.status === 404) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Member not found');
                    });
                } else if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Invalid request');
                    });
                } else {
                    throw new Error('Failed to resend invitation');
                }
            })
            .catch(error => {
                console.error('Error resending invitation:', error);
                showError(error.message || 'An error occurred while resending the invitation.');
            });
        }
        
        // Handle update settings
        function handleUpdateSettings(settings) {
            // The backend API currently only supports IsArchived setting
            // We'll need to map the Angular settings to what the API expects
            const requestData = {
                id: @Model.Id,
                isArchived: false // Default value, can be extended later
            };
            
            fetch('/api/household/@Model.Id/settings', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getAntiForgeryToken()
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Household not found');
                    });
                } else if (response.status === 400) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Invalid request');
                    });
                } else {
                    throw new Error('Failed to update settings');
                }
            })
            .then(data => {
                showSuccess('Settings updated successfully!');
                // Optionally reload to reflect changes
                // window.location.reload();
            })
            .catch(error => {
                console.error('Error updating settings:', error);
                showError(error.message || 'An error occurred while updating settings.');
            });
        }
    })();
</script>

<!-- Anti-forgery token for AJAX requests -->
@Html.AntiForgeryToken()

<!-- Fallback content for browsers without JavaScript -->
<noscript>
    <div class="container mt-4">
        <div class="alert alert-warning">
            <strong>JavaScript is disabled.</strong> This page requires JavaScript to display household details.
            Please enable JavaScript in your browser settings.
        </div>
        <div class="card">
            <div class="card-body">
                <h2>@Model.HouseholdName</h2>
                <dl class="row">
                    <dt class="col-sm-3">Anchor Person</dt>
                    <dd class="col-sm-9">
                        @if (Model.AnchorPersonId.HasValue)
                        {
                            <a asp-controller="Person" asp-action="Details" asp-route-id="@Model.AnchorPersonId">@Model.AnchorPersonName</a>
                        }
                        else
                        {
                            <span class="text-muted">Not set</span>
                        }
                    </dd>
                    <dt class="col-sm-3">Members</dt>
                    <dd class="col-sm-9">@Model.MemberCount</dd>
                </dl>
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            </div>
        </div>
    </div>
</noscript>
