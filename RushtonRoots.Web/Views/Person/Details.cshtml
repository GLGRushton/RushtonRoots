@model RushtonRoots.Domain.UI.Models.PersonViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Person Details";
    var canEdit = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    
    // Transform PersonViewModel to PersonDetails format for Angular component
    var personData = new
    {
        id = Model.Id,
        firstName = Model.FirstName,
        lastName = Model.LastName,
        fullName = Model.FullName,
        dateOfBirth = Model.DateOfBirth?.ToString("o"),
        dateOfDeath = Model.DateOfDeath?.ToString("o"),
        isDeceased = Model.IsDeceased,
        householdId = Model.HouseholdId,
        householdName = Model.HouseholdName,
        photoUrl = Model.PhotoUrl
    };
    
    // Transform timeline events (birth and death events auto-generated by component)
    var timelineEvents = new object[] { };
    
    // Transform relationships for Angular component
    var relationships = new List<object>();
    
    // Add parent relationships
    foreach (var parent in Model.ParentRelationships)
    {
        relationships.Add(new
        {
            relationshipType = "parent",
            relatedPerson = new
            {
                id = parent.ParentId,
                firstName = parent.ParentName?.Split(' ').FirstOrDefault() ?? "",
                lastName = parent.ParentName?.Split(' ').Skip(1).FirstOrDefault() ?? "",
                fullName = parent.ParentName,
                isDeceased = false,
                photoUrl = ""
            },
            relationshipDetails = parent.RelationshipType
        });
    }
    
    // Add child relationships
    foreach (var child in Model.ChildRelationships)
    {
        relationships.Add(new
        {
            relationshipType = "child",
            relatedPerson = new
            {
                id = child.ChildId,
                firstName = child.ChildName?.Split(' ').FirstOrDefault() ?? "",
                lastName = child.ChildName?.Split(' ').Skip(1).FirstOrDefault() ?? "",
                fullName = child.ChildName,
                isDeceased = false,
                photoUrl = ""
            },
            relationshipDetails = child.RelationshipType
        });
    }
    
    // Add spouse/partner relationships
    foreach (var partnership in Model.Partnerships)
    {
        var partnerId = partnership.PersonAId == Model.Id ? partnership.PersonBId : partnership.PersonAId;
        var partnerName = partnership.PersonAId == Model.Id ? partnership.PersonBName : partnership.PersonAName;
        
        relationships.Add(new
        {
            relationshipType = "spouse",
            relatedPerson = new
            {
                id = partnerId,
                firstName = partnerName?.Split(' ').FirstOrDefault() ?? "",
                lastName = partnerName?.Split(' ').Skip(1).FirstOrDefault() ?? "",
                fullName = partnerName,
                isDeceased = false,
                photoUrl = ""
            },
            relationshipDetails = partnership.PartnershipType,
            startDate = partnership.StartDate?.ToString("o"),
            endDate = partnership.EndDate?.ToString("o")
        });
    }
    
    // Photos - currently empty, will be populated when photo feature is implemented
    var photos = new object[] { };
    
    var personJson = JsonSerializer.Serialize(personData);
    var timelineJson = JsonSerializer.Serialize(timelineEvents);
    var relationshipsJson = JsonSerializer.Serialize(relationships);
    var photosJson = JsonSerializer.Serialize(photos);
}

<!-- Angular PersonDetailsComponent -->
<app-person-details 
    id="personDetailsComponent"
    person='@Html.Raw(personJson)'
    timeline-events='@Html.Raw(timelineJson)'
    relationships='@Html.Raw(relationshipsJson)'
    photos='@Html.Raw(photosJson)'
    can-edit="@canEdit.ToString().ToLower()"
    can-delete="@canEdit.ToString().ToLower()"
    initial-tab="0">
</app-person-details>

<!-- Fallback content for browsers without JavaScript -->
<noscript>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Person Details</h2>
            <div>
                @if (canEdit)
                {
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">Edit</a>
                    <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Delete</a>
                }
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Full Name</dt>
                    <dd class="col-sm-9">@Model.FullName</dd>

                    <dt class="col-sm-3">Household</dt>
                    <dd class="col-sm-9">@Model.HouseholdName</dd>

                    <dt class="col-sm-3">Date of Birth</dt>
                    <dd class="col-sm-9">@(Model.DateOfBirth?.ToString("MMMM dd, yyyy") ?? "N/A")</dd>

                    @if (Model.IsDeceased)
                    {
                        <dt class="col-sm-3">Date of Death</dt>
                        <dd class="col-sm-9">@(Model.DateOfDeath?.ToString("MMMM dd, yyyy") ?? "N/A")</dd>
                    }
                </dl>
            </div>
        </div>
    </div>
</noscript>

@section Scripts {
    <script>
        // Handle person details component events
        document.addEventListener('DOMContentLoaded', function() {
            const detailsComponent = document.getElementById('personDetailsComponent');
            
            if (detailsComponent) {
                // Listen for edit clicked event
                detailsComponent.addEventListener('editClicked', function(event) {
                    const personId = event.detail;
                    window.location.href = '@Url.Action("Edit", "Person")/' + personId;
                });
                
                // Listen for delete clicked event
                detailsComponent.addEventListener('deleteClicked', function(event) {
                    const personId = event.detail;
                    window.location.href = '@Url.Action("Delete", "Person")/' + personId;
                });
                
                // Listen for share clicked event
                detailsComponent.addEventListener('shareClicked', function(event) {
                    const personId = event.detail;
                    const shareUrl = window.location.href;
                    
                    // Copy URL to clipboard
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(shareUrl)
                            .then(() => {
                                alert('Link copied to clipboard!');
                            })
                            .catch(err => {
                                console.error('Failed to copy: ', err);
                                // Fallback: show URL in prompt
                                prompt('Copy this link:', shareUrl);
                            });
                    } else {
                        // Fallback for older browsers
                        prompt('Copy this link:', shareUrl);
                    }
                });
                
                // Listen for relationship person clicked event
                detailsComponent.addEventListener('relationshipPersonClicked', function(event) {
                    const relatedPersonId = event.detail;
                    window.location.href = '@Url.Action("Details", "Person")/' + relatedPersonId;
                });
                
                // Listen for photo uploaded event
                detailsComponent.addEventListener('photoUploaded', function(event) {
                    const file = event.detail;
                    console.log('Photo uploaded:', file);
                    // TODO: Implement photo upload functionality
                    alert('Photo upload functionality will be implemented in a future update.');
                });
                
                // Listen for photo deleted event
                detailsComponent.addEventListener('photoDeleted', function(event) {
                    const photoId = event.detail;
                    console.log('Photo deleted:', photoId);
                    // TODO: Implement photo delete functionality
                    alert('Photo delete functionality will be implemented in a future update.');
                });
                
                // Listen for photo primary changed event
                detailsComponent.addEventListener('photoPrimaryChanged', function(event) {
                    const photoId = event.detail;
                    console.log('Primary photo changed:', photoId);
                    // TODO: Implement photo primary change functionality
                    alert('Set primary photo functionality will be implemented in a future update.');
                });
                
                // Listen for field updated event (inline editing)
                detailsComponent.addEventListener('fieldUpdated', function(event) {
                    const { field, value } = event.detail;
                    console.log('Field updated:', field, value);
                    
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('Id', @Model.Id);
                    formData.append('Field', field);
                    formData.append('Value', value);
                    
                    // Add anti-forgery token
                    const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                    if (tokenElement && tokenElement.value) {
                        formData.append('__RequestVerificationToken', tokenElement.value);
                    }
                    
                    // Submit update request
                    fetch('@Url.Action("UpdateField", "Person")', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Field updated successfully!');
                        } else {
                            alert('Error updating field. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating field. Please try again.');
                    });
                });
            }
        });
    </script>
    
    @Html.AntiForgeryToken()
}
