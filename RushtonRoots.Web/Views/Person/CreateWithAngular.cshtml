@{
    ViewData["Title"] = "Create Person";
}

<div class="container mt-4">
    <!-- PersonFormComponent - Phase 3.3 Implementation -->
    <app-person-form id="personCreateForm"></app-person-form>
</div>

@section Scripts {
    <script>
        // Wait for the component to be defined
        customElements.whenDefined('app-person-form').then(() => {
            const formElement = document.getElementById('personCreateForm');

            if (formElement) {
                // Handle successful form submission
                formElement.addEventListener('formSubmit', async (event) => {
                    const formData = event.detail;
                    console.log('Person form submitted:', formData);

                    try {
                        // Determine if we need multipart for photo upload
                        if (formData.photoFile) {
                            // Create FormData for multipart upload
                            const uploadData = new FormData();
                            uploadData.append('photo', formData.photoFile);
                            
                            // Append other fields
                            Object.keys(formData).forEach(key => {
                                if (key !== 'photoFile' && key !== 'photoUrl' && formData[key] !== undefined && formData[key] !== null) {
                                    uploadData.append(key, formData[key]);
                                }
                            });

                            const response = await fetch('/api/person', {
                                method: 'POST',
                                body: uploadData,
                                headers: {
                                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                                }
                            });

                            if (response.ok) {
                                const person = await response.json();
                                // Show success message
                                alert('Person created successfully!');
                                // Redirect to person details page
                                window.location.href = `/Person/Details/${person.id}`;
                            } else {
                                const error = await response.text();
                                alert('Failed to create person: ' + error);
                            }
                        } else {
                            // JSON submission without photo
                            const response = await fetch('/api/person', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                                },
                                body: JSON.stringify(formData)
                            });

                            if (response.ok) {
                                const person = await response.json();
                                // Show success message
                                alert('Person created successfully!');
                                // Redirect to person details page
                                window.location.href = `/Person/Details/${person.id}`;
                            } else {
                                const error = await response.text();
                                alert('Failed to create person: ' + error);
                            }
                        }
                    } catch (error) {
                        console.error('Error creating person:', error);
                        alert('An error occurred while creating the person. Please try again.');
                    }
                });

                // Handle form cancellation
                formElement.addEventListener('formCancel', () => {
                    console.log('Person form cancelled');
                    // Navigate back to person index
                    window.location.href = '/Person/Index';
                });
            }
        });
    </script>
}
