@model IEnumerable<RushtonRoots.Domain.UI.Models.PersonViewModel>
@using System.Text.Json
@{
    ViewData["Title"] = "People";
    var searchRequest = ViewBag.SearchRequest as RushtonRoots.Domain.UI.Requests.SearchPersonRequest;
    var households = ViewBag.Households as IEnumerable<RushtonRoots.Domain.UI.Models.HouseholdViewModel>;
    var canEdit = User.IsInRole("Admin") || User.IsInRole("HouseholdAdmin");
    
    // Transform PersonViewModel to PersonTableRow format for Angular component
    var peopleData = Model.Select(p => new
    {
        id = p.Id,
        firstName = p.FirstName,
        lastName = p.LastName,
        fullName = p.FullName,
        householdName = p.HouseholdName,
        dateOfBirth = p.DateOfBirth,
        dateOfDeath = p.DateOfDeath,
        isDeceased = p.IsDeceased,
        photoUrl = p.PhotoUrl
    }).ToArray();
    
    // Transform households for Angular component
    var householdsData = households?.Select(h => new
    {
        id = h.Id,
        householdName = h.HouseholdName
    }).ToArray() ?? Array.Empty<object>();
    
    // Transform initial filters
    var initialFilters = new
    {
        searchTerm = searchRequest?.SearchTerm,
        householdId = searchRequest?.HouseholdId,
        isDeceased = searchRequest?.IsDeceased,
        birthDateFrom = searchRequest?.BirthDateFrom,
        birthDateTo = searchRequest?.BirthDateTo,
        deathDateFrom = searchRequest?.DeathDateFrom,
        deathDateTo = searchRequest?.DeathDateTo,
        surname = searchRequest?.Surname
    };
    
    var peopleJson = JsonSerializer.Serialize(peopleData);
    var householdsJson = JsonSerializer.Serialize(householdsData);
    var filtersJson = JsonSerializer.Serialize(initialFilters);
}

<!-- Angular PersonIndexComponent -->
<app-person-index 
    initial-people='@Html.Raw(peopleJson)'
    households='@Html.Raw(householdsJson)'
    initial-filters='@Html.Raw(filtersJson)'
    can-edit="@canEdit.ToString().ToLower()"
    can-delete="@canEdit.ToString().ToLower()">
</app-person-index>

@section Scripts {
    <script>
        // Ensure Angular Elements are loaded
        console.log('Person Index page loaded with Angular PersonIndexComponent');
    </script>
}
