<div class="parent-child-form">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        {{ isEditMode ? 'Edit' : 'Add' }} Parent-Child Relationship
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="relationshipForm">
        <!-- Parent Selection -->
        <div class="form-section">
          <h3>Parent</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Parent</mat-label>
            <input type="text"
                   matInput
                   formControlName="parentSearch"
                   [matAutocomplete]="parentAuto"
                   placeholder="Start typing to search...">
            <mat-icon matPrefix>person</mat-icon>
            <mat-autocomplete #parentAuto="matAutocomplete" 
                              [displayWith]="displayPerson"
                              (optionSelected)="onParentSelected($event.option.value)">
              <mat-option *ngFor="let person of filteredParentOptions | async" [value]="person">
                <div class="person-option">
                  <div class="avatar avatar-small">
                    <img *ngIf="person.photoUrl" [src]="person.photoUrl" [alt]="person.name">
                    <span *ngIf="!person.photoUrl">{{ getInitials(person.name) }}</span>
                  </div>
                  <div class="person-details">
                    <div class="person-name">{{ person.name }}</div>
                    <div class="person-meta" *ngIf="person.birthDate">
                      Born: {{ person.birthDate | date:'yyyy' }}
                      <span *ngIf="person.age"> ({{ person.age }} years old)</span>
                    </div>
                  </div>
                </div>
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="relationshipForm.get('parentPersonId')?.hasError('required')">
              Parent is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Child Selection -->
        <div class="form-section">
          <h3>Child</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Child</mat-label>
            <input type="text"
                   matInput
                   formControlName="childSearch"
                   [matAutocomplete]="childAuto"
                   placeholder="Start typing to search...">
            <mat-icon matPrefix>child_care</mat-icon>
            <mat-autocomplete #childAuto="matAutocomplete" 
                              [displayWith]="displayPerson"
                              (optionSelected)="onChildSelected($event.option.value)">
              <mat-option *ngFor="let person of filteredChildOptions | async" [value]="person">
                <div class="person-option">
                  <div class="avatar avatar-small">
                    <img *ngIf="person.photoUrl" [src]="person.photoUrl" [alt]="person.name">
                    <span *ngIf="!person.photoUrl">{{ getInitials(person.name) }}</span>
                  </div>
                  <div class="person-details">
                    <div class="person-name">{{ person.name }}</div>
                    <div class="person-meta" *ngIf="person.birthDate">
                      Born: {{ person.birthDate | date:'yyyy' }}
                      <span *ngIf="person.age"> ({{ person.age }} years old)</span>
                    </div>
                  </div>
                </div>
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="relationshipForm.get('childPersonId')?.hasError('required')">
              Child is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Relationship Type -->
        <div class="form-section">
          <h3>Relationship Type</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Type</mat-label>
            <mat-select formControlName="relationshipType">
              <mat-option *ngFor="let type of relationshipTypes" [value]="type.value">
                <div class="type-option">
                  <mat-icon [style.color]="type.color === 'primary' ? '#2e7d32' : '#66bb6a'">
                    {{ type.icon }}
                  </mat-icon>
                  <span>{{ type.display }}</span>
                </div>
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Type Description -->
          <div class="type-description" *ngIf="selectedTypeConfig">
            <mat-icon>info</mat-icon>
            <p>{{ selectedTypeConfig.description }}</p>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-section">
          <h3>Notes (Optional)</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Additional Information</mat-label>
            <textarea matInput
                      formControlName="notes"
                      rows="4"
                      placeholder="Add any additional details about this relationship..."></textarea>
            <mat-hint align="end">
              {{ relationshipForm.get('notes')?.value?.length || 0 }} / 500
            </mat-hint>
            <mat-error *ngIf="relationshipForm.get('notes')?.hasError('maxlength')">
              Notes cannot exceed 500 characters
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Verified Checkbox -->
        <div class="form-section">
          <mat-checkbox formControlName="isVerified">
            <span class="verified-label">
              <mat-icon>verified</mat-icon>
              Mark as verified
            </span>
          </mat-checkbox>
          <p class="verified-hint">
            Check this if you have confirmed this relationship through documentation or reliable sources.
          </p>
        </div>

        <!-- Validation Results -->
        <div class="validation-section" *ngIf="showValidation && validationResult">
          <mat-expansion-panel [expanded]="true">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon *ngIf="validationResult.isValid && validationResult.errors.length === 0" 
                          color="primary">
                  check_circle
                </mat-icon>
                <mat-icon *ngIf="validationResult.errors.length > 0" color="warn">
                  error
                </mat-icon>
                Validation Results
              </mat-panel-title>
            </mat-expansion-panel-header>

            <!-- Errors -->
            <div class="validation-errors" *ngIf="validationResult.errors.length > 0">
              <div class="validation-item error" *ngFor="let error of validationResult.errors">
                <mat-icon>error</mat-icon>
                <div>
                  <strong>{{ error.message }}</strong>
                  <p *ngIf="error.details">{{ error.details }}</p>
                </div>
              </div>
            </div>

            <!-- Warnings -->
            <div class="validation-warnings" *ngIf="validationResult.warnings.length > 0">
              <div class="validation-item warning" *ngFor="let warning of validationResult.warnings">
                <mat-icon>warning</mat-icon>
                <div>
                  <strong>{{ warning.message }}</strong>
                  <p *ngIf="warning.details">{{ warning.details }}</p>
                </div>
              </div>
            </div>

            <!-- Success -->
            <div class="validation-success" *ngIf="validationResult.isValid && 
                                                   validationResult.errors.length === 0 && 
                                                   validationResult.warnings.length === 0">
              <mat-icon>check_circle</mat-icon>
              <p>This relationship looks good! No issues detected.</p>
            </div>
          </mat-expansion-panel>
        </div>
      </form>
    </mat-card-content>

    <!-- Actions -->
    <mat-card-actions>
      <button mat-button 
              type="button"
              (click)="onValidate()"
              [disabled]="!relationshipForm.valid || isSubmitting">
        <mat-icon>rule</mat-icon>
        Validate
      </button>
      <div class="spacer"></div>
      <button mat-button 
              type="button"
              (click)="onCancel()"
              [disabled]="isSubmitting">
        Cancel
      </button>
      <button mat-raised-button 
              color="primary"
              type="submit"
              (click)="onSubmit()"
              [disabled]="!relationshipForm.valid || isSubmitting">
        <mat-icon *ngIf="!isSubmitting">save</mat-icon>
        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
        {{ isEditMode ? 'Update' : 'Create' }} Relationship
      </button>
    </mat-card-actions>
  </mat-card>
</div>
