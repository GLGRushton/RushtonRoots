<div class="notification-panel-container">
  <!-- Header -->
  <div class="notification-header">
    <h2 class="notification-title">
      <mat-icon>notifications</mat-icon>
      Notifications
      <mat-chip *ngIf="getUnreadCount() > 0" 
                class="unread-count-badge"
                [highlighted]="true">
        {{ getUnreadCount() }}
      </mat-chip>
    </h2>
    
    <div class="header-actions">
      <button mat-icon-button 
              [matMenuTriggerFor]="filterMenu"
              matTooltip="Filter notifications"
              aria-label="Filter notifications">
        <mat-icon>filter_list</mat-icon>
      </button>
      
      <mat-menu #filterMenu="matMenu">
        <button mat-menu-item (click)="setFilter(undefined)">
          <mat-icon>notifications</mat-icon>
          <span>All Notifications</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item 
                *ngFor="let config of notificationTypeConfigs"
                (click)="setFilter(config.type)">
          <mat-icon [style.color]="config.color">{{ config.icon }}</mat-icon>
          <span>{{ config.label }}</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="toggleShowRead()">
          <mat-icon>{{ showReadNotifications ? 'visibility_off' : 'visibility' }}</mat-icon>
          <span>{{ showReadNotifications ? 'Hide Read' : 'Show Read' }}</span>
        </button>
      </mat-menu>
      
      <button mat-icon-button 
              [matMenuTriggerFor]="actionsMenu"
              matTooltip="More actions"
              aria-label="More actions">
        <mat-icon>more_vert</mat-icon>
      </button>
      
      <mat-menu #actionsMenu="matMenu">
        <button mat-menu-item 
                (click)="markAllAsRead()"
                [disabled]="getUnreadCount() === 0">
          <mat-icon>done_all</mat-icon>
          <span>Mark All as Read</span>
        </button>
        <button mat-menu-item 
                (click)="clearAllNotifications()"
                [disabled]="notifications.length === 0"
                class="delete-action">
          <mat-icon>clear_all</mat-icon>
          <span>Clear All</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Active filter chip -->
  <div class="active-filters" *ngIf="selectedFilter">
    <mat-chip-set aria-label="Active filters">
      <mat-chip (removed)="setFilter(undefined)">
        <mat-icon [style.color]="getNotificationColor(selectedFilter)">
          {{ getNotificationIcon(selectedFilter) }}
        </mat-icon>
        {{ getNotificationLabel(selectedFilter) }}
        <button matChipRemove aria-label="Remove filter">
          <mat-icon>cancel</mat-icon>
        </button>
      </mat-chip>
    </mat-chip-set>
  </div>

  <!-- Notification list -->
  <div class="notification-list">
    <!-- Empty state -->
    <div class="empty-state" *ngIf="filteredNotifications.length === 0">
      <mat-icon>notifications_none</mat-icon>
      <p *ngIf="!selectedFilter && showReadNotifications">No notifications yet</p>
      <p *ngIf="selectedFilter">No {{ getNotificationLabel(selectedFilter).toLowerCase() }} notifications</p>
      <p *ngIf="!showReadNotifications && !selectedFilter">No unread notifications</p>
    </div>

    <!-- Ungrouped notifications -->
    <div class="notification-items" *ngIf="!groupNotifications && filteredNotifications.length > 0">
      <div *ngFor="let notification of filteredNotifications; trackBy: trackByNotificationId"
           class="notification-item"
           [class.unread]="!notification.isRead"
           (click)="onNotificationClick(notification)">
        
        <!-- Notification icon -->
        <div class="notification-icon" 
             [style.background-color]="getNotificationColor(notification.type)">
          <mat-icon>{{ getNotificationIcon(notification.type) }}</mat-icon>
        </div>

        <!-- Notification content -->
        <div class="notification-content">
          <div class="notification-title-row">
            <span class="notification-title-text">{{ notification.title }}</span>
            <span class="notification-time">{{ formatTimestamp(notification.timestamp) }}</span>
          </div>
          
          <p class="notification-message">{{ notification.message }}</p>
          
          <!-- Actor info -->
          <div class="notification-actor" *ngIf="notification.actorName">
            <img *ngIf="notification.actorAvatarUrl" 
                 [src]="notification.actorAvatarUrl" 
                 [alt]="notification.actorName"
                 class="actor-avatar">
            <span class="actor-name">{{ notification.actorName }}</span>
          </div>

          <!-- Action button -->
          <button mat-stroked-button 
                  *ngIf="notification.actionUrl && notification.actionLabel"
                  class="notification-action-btn"
                  (click)="$event.stopPropagation()">
            {{ notification.actionLabel }}
          </button>
        </div>

        <!-- Unread indicator -->
        <div class="unread-indicator" *ngIf="!notification.isRead"></div>

        <!-- Actions -->
        <div class="notification-actions" (click)="$event.stopPropagation()">
          <button mat-icon-button 
                  [matMenuTriggerFor]="notificationMenu"
                  aria-label="Notification options">
            <mat-icon>more_vert</mat-icon>
          </button>
          
          <mat-menu #notificationMenu="matMenu">
            <button mat-menu-item (click)="toggleReadStatus(notification, $event)">
              <mat-icon>{{ notification.isRead ? 'mark_email_unread' : 'mark_email_read' }}</mat-icon>
              <span>{{ notification.isRead ? 'Mark as Unread' : 'Mark as Read' }}</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="deleteNotification(notification.id, $event)" class="delete-action">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </div>
      </div>
    </div>

    <!-- Grouped notifications -->
    <div class="notification-groups" *ngIf="groupNotifications && groupedNotifications.length > 0">
      <mat-accordion>
        <mat-expansion-panel *ngFor="let group of groupedNotifications; trackBy: trackByGroupKey"
                             [class.unread]="!group.allRead">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="group-icon" 
                   [style.background-color]="getNotificationColor(group.type)">
                <mat-icon>{{ getNotificationIcon(group.type) }}</mat-icon>
              </div>
              <div class="group-info">
                <span class="group-title">{{ getGroupSummary(group) }}</span>
                <span class="group-time">{{ formatTimestamp(group.latestNotification.timestamp) }}</span>
              </div>
              <mat-chip *ngIf="!group.allRead" 
                        class="group-unread-badge"
                        [highlighted]="true">
                {{ getUnreadCountInGroup(group) }}
              </mat-chip>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <!-- Group notifications -->
          <div class="group-notifications">
            <div *ngFor="let notification of group.notifications; trackBy: trackByNotificationId"
                 class="grouped-notification"
                 [class.unread]="!notification.isRead"
                 (click)="onNotificationClick(notification)">
              
              <div class="grouped-notification-content">
                <p class="grouped-notification-message">{{ notification.message }}</p>
                <span class="grouped-notification-time">{{ formatTimestamp(notification.timestamp) }}</span>
              </div>

              <div class="grouped-notification-actions" (click)="$event.stopPropagation()">
                <button mat-icon-button 
                        (click)="toggleReadStatus(notification, $event)"
                        [matTooltip]="notification.isRead ? 'Mark as unread' : 'Mark as read'"
                        aria-label="Toggle read status">
                  <mat-icon>{{ notification.isRead ? 'mark_email_unread' : 'mark_email_read' }}</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="deleteNotification(notification.id, $event)"
                        matTooltip="Delete"
                        aria-label="Delete notification">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </div>
</div>
