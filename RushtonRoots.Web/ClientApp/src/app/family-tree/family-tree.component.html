<div class="family-tree-container">
  <!-- Control Panel -->
  <div class="control-panel">
    <div class="view-mode-selector">
      <button 
        class="mode-btn" 
        [class.active]="viewMode === 'descendant'"
        (click)="setViewMode('descendant')"
        title="Descendant Chart - Show children and descendants">
        ğŸ“Š Descendants
      </button>
      <button 
        class="mode-btn" 
        [class.active]="viewMode === 'pedigree'"
        (click)="setViewMode('pedigree')"
        title="Pedigree Chart - Show parents and ancestors">
        ğŸŒ³ Pedigree
      </button>
      <button 
        class="mode-btn" 
        [class.active]="viewMode === 'fan'"
        (click)="setViewMode('fan')"
        title="Fan Chart - Circular ancestor view">
        â­• Fan Chart
      </button>
    </div>

    <div class="zoom-controls">
      <button class="control-btn" (click)="zoomOut()" title="Zoom Out">ğŸ”âˆ’</button>
      <span class="zoom-level">{{ (zoom * 100).toFixed(0) }}%</span>
      <button class="control-btn" (click)="zoomIn()" title="Zoom In">ğŸ”+</button>
      <button class="control-btn" (click)="resetZoom()" title="Reset View">âŸ²</button>
      <button class="control-btn" (click)="print()" title="Print">ğŸ–¨ï¸</button>
    </div>

    <div class="person-selector" *ngIf="allPeople.length > 0">
      <label>Focus on:</label>
      <select [(ngModel)]="selectedPersonId" (change)="loadTreeView()">
        <option *ngFor="let person of allPeople" [value]="person.id">
          {{ getPersonDisplayName(person) }}
        </option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="loading">
    <div class="spinner"></div>
    <p>Loading family tree...</p>
  </div>

  <!-- Error State -->
  <div class="error" *ngIf="error && !loading">
    <p>âš ï¸ {{ error }}</p>
    <button class="control-btn retry-btn" (click)="loadFamilyData()" title="Retry">
      ğŸ”„ Retry
    </button>
  </div>

  <!-- Tree Visualization -->
  <div class="tree-viewport" *ngIf="!loading && treeData">
    <div 
      class="tree-canvas" 
      [style.transform]="'scale(' + zoom + ') translate(' + panX + 'px, ' + panY + 'px)'">
      
      <!-- Descendant View -->
      <div *ngIf="viewMode === 'descendant'" class="descendant-view">
        <ng-container *ngTemplateOutlet="descendantNode; context: { node: treeData, depth: 0 }"></ng-container>
      </div>

      <!-- Pedigree View -->
      <div *ngIf="viewMode === 'pedigree'" class="pedigree-view">
        <ng-container *ngTemplateOutlet="pedigreeNode; context: { node: treeData, depth: 0 }"></ng-container>
      </div>

      <!-- Fan Chart View -->
      <div *ngIf="viewMode === 'fan'" class="fan-view">
        <div class="fan-chart-info">
          <p>Fan Chart visualization coming soon!</p>
          <p class="hint">This will show ancestors in a circular, space-efficient layout.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Descendant Node Template -->
<ng-template #descendantNode let-node="node" let-depth="depth">
  <div class="tree-node descendant-node" [attr.data-depth]="depth">
    <!-- Person and Partner -->
    <div class="couple-container">
      <div class="person-card" [class.deceased]="node.person?.isDeceased">
        <div class="person-name">{{ getPersonDisplayName(node.person) }}</div>
        <div class="person-years" *ngIf="getPersonYears(node.person)">
          {{ getPersonYears(node.person) }}
        </div>
      </div>
      
      <div class="connection-line" *ngIf="node.partner">â¤ï¸</div>
      
      <div class="person-card" *ngIf="node.partner" [class.deceased]="node.partner?.isDeceased">
        <div class="person-name">{{ getPersonDisplayName(node.partner) }}</div>
        <div class="person-years" *ngIf="getPersonYears(node.partner)">
          {{ getPersonYears(node.partner) }}
        </div>
      </div>
    </div>

    <!-- Children -->
    <div class="children-container" *ngIf="node.children && node.children.length > 0">
      <div class="connector-line"></div>
      <div class="children-grid">
        <ng-container *ngFor="let child of node.children">
          <ng-container *ngTemplateOutlet="descendantNode; context: { node: child, depth: depth + 1 }"></ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</ng-template>

<!-- Pedigree Node Template -->
<ng-template #pedigreeNode let-node="node" let-depth="depth">
  <div class="tree-node pedigree-node" [attr.data-depth]="depth">
    <div class="pedigree-layout">
      <!-- Parents (on the left/top) -->
      <div class="parents-container" *ngIf="node.parents && node.parents.length > 0">
        <ng-container *ngFor="let parent of node.parents">
          <ng-container *ngTemplateOutlet="pedigreeNode; context: { node: parent, depth: depth + 1 }"></ng-container>
        </ng-container>
      </div>

      <!-- Current Person -->
      <div class="person-card pedigree-person" [class.deceased]="node.person?.isDeceased">
        <div class="person-name">{{ getPersonDisplayName(node.person) }}</div>
        <div class="person-years" *ngIf="getPersonYears(node.person)">
          {{ getPersonYears(node.person) }}
        </div>
        <div class="generation-label">Gen {{ node.generation }}</div>
      </div>
    </div>
  </div>
</ng-template>

