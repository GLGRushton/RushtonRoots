<mat-card class="household-form-card">
  <mat-card-header>
    <mat-card-title>
      {{ isEditMode ? 'Edit Household' : 'Create New Household' }}
    </mat-card-title>
    <mat-card-subtitle>
      {{ isEditMode ? 'Update household information and settings' : 'Set up a new family household' }}
    </mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="householdForm" (ngSubmit)="onSubmit()">
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>home</mat-icon>
          Basic Information
        </h3>

        <!-- Household Name -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Household Name</mat-label>
          <input matInput 
                 formControlName="householdName" 
                 placeholder="e.g., Smith Family"
                 maxlength="200"
                 required>
          <mat-icon matPrefix>family_restroom</mat-icon>
          <mat-hint>A descriptive name for this household</mat-hint>
          <mat-error *ngIf="householdForm.get('householdName')?.hasError('required')">
            Household name is required
          </mat-error>
          <mat-error *ngIf="householdForm.get('householdName')?.hasError('maxlength')">
            Name cannot exceed 200 characters
          </mat-error>
        </mat-form-field>

        <!-- Description -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput 
                    formControlName="description"
                    placeholder="Brief description of this household..."
                    rows="3"
                    maxlength="2000"></textarea>
          <mat-icon matPrefix>description</mat-icon>
          <mat-hint align="end">{{ householdForm.get('description')?.value?.length || 0 }}/2000</mat-hint>
        </mat-form-field>
      </div>

      <!-- Anchor Person Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>person_pin</mat-icon>
          Anchor Person (Optional)
        </h3>
        <p class="section-description">
          The anchor person is the direct descendant this household is centered around.
        </p>

        <!-- Selected Anchor Person Display -->
        <div *ngIf="selectedAnchorPerson" class="selected-person-card">
          <mat-card>
            <mat-card-content class="person-card-content">
              <div class="person-avatar">
                <img *ngIf="selectedAnchorPerson.photoUrl" 
                     [src]="selectedAnchorPerson.photoUrl" 
                     [alt]="selectedAnchorPerson.fullName">
                <div *ngIf="!selectedAnchorPerson.photoUrl" class="avatar-placeholder">
                  {{ selectedAnchorPerson.firstName[0] }}{{ selectedAnchorPerson.lastName[0] }}
                </div>
              </div>
              <div class="person-info">
                <div class="person-name">{{ selectedAnchorPerson.fullName }}</div>
                <div class="person-details" *ngIf="selectedAnchorPerson.dateOfBirth">
                  Born: {{ selectedAnchorPerson.dateOfBirth | date:'mediumDate' }}
                </div>
              </div>
              <button mat-icon-button 
                      type="button"
                      (click)="clearAnchorPerson()"
                      matTooltip="Remove anchor person">
                <mat-icon>close</mat-icon>
              </button>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Anchor Person Autocomplete -->
        <mat-form-field appearance="outline" class="full-width" *ngIf="!selectedAnchorPerson">
          <mat-label>Search for Anchor Person</mat-label>
          <input matInput 
                 formControlName="anchorPersonSearch"
                 placeholder="Type to search..."
                 [matAutocomplete]="autoAnchor">
          <mat-icon matPrefix>search</mat-icon>
          <mat-autocomplete #autoAnchor="matAutocomplete" 
                           [displayWith]="displayPersonFn"
                           (optionSelected)="onAnchorPersonSelected($event.option.value)">
            <mat-option *ngFor="let person of filteredPeople" [value]="person">
              <div class="autocomplete-option">
                <div class="option-avatar">
                  <img *ngIf="person.photoUrl" [src]="person.photoUrl" [alt]="person.fullName">
                  <div *ngIf="!person.photoUrl" class="avatar-small">
                    {{ person.firstName[0] }}{{ person.lastName[0] }}
                  </div>
                </div>
                <div class="option-info">
                  <div class="option-name">{{ person.fullName }}</div>
                  <div class="option-details" *ngIf="person.dateOfBirth">
                    Born: {{ person.dateOfBirth | date:'mediumDate' }}
                  </div>
                </div>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <!-- Initial Members Section (Create mode only) -->
      <div class="form-section" *ngIf="!isEditMode">
        <h3 class="section-title">
          <mat-icon>group_add</mat-icon>
          Initial Members (Optional)
        </h3>
        <p class="section-description">
          Add family members to this household. You can also add members later.
        </p>

        <!-- Selected Members List -->
        <div class="selected-members-list" *ngIf="selectedMembers.length > 0">
          <div *ngFor="let member of selectedMembers" class="member-card">
            <mat-card>
              <mat-card-content class="member-card-content">
                <div class="member-avatar">
                  <img *ngIf="member.photoUrl" [src]="member.photoUrl" [alt]="member.fullName">
                  <div *ngIf="!member.photoUrl" class="avatar-placeholder">
                    {{ member.fullName.split(' ')[0][0] }}{{ member.fullName.split(' ')[1] && member.fullName.split(' ')[1][0] || '' }}
                  </div>
                </div>
                <div class="member-info">
                  <div class="member-name">{{ member.fullName }}</div>
                  <mat-form-field appearance="outline" class="role-select">
                    <mat-label>Role</mat-label>
                    <mat-select [(value)]="member.role" 
                               (selectionChange)="updateMemberRole(member, $event.value)">
                      <mat-option *ngFor="let role of memberRoles" [value]="role.value">
                        <mat-icon [style.color]="role.color">{{ role.icon }}</mat-icon>
                        {{ role.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <button mat-icon-button 
                        type="button"
                        (click)="removeMember(member)"
                        matTooltip="Remove member">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <!-- Member Search Autocomplete -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Search to Add Members</mat-label>
          <input matInput 
                 formControlName="memberSearch"
                 placeholder="Type to search..."
                 [matAutocomplete]="autoMembers">
          <mat-icon matPrefix>person_add</mat-icon>
          <mat-hint>Search for family members to add to this household</mat-hint>
          <mat-autocomplete #autoMembers="matAutocomplete" 
                           [displayWith]="displayPersonFn"
                           (optionSelected)="onMemberSelected($event.option.value)">
            <mat-option *ngFor="let person of filteredMembers" [value]="person">
              <div class="autocomplete-option">
                <div class="option-avatar">
                  <img *ngIf="person.photoUrl" [src]="person.photoUrl" [alt]="person.fullName">
                  <div *ngIf="!person.photoUrl" class="avatar-small">
                    {{ person.firstName[0] }}{{ person.lastName[0] }}
                  </div>
                </div>
                <div class="option-info">
                  <div class="option-name">{{ person.fullName }}</div>
                  <div class="option-details" *ngIf="person.householdName">
                    Current Household: {{ person.householdName }}
                  </div>
                </div>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>
      </div>

      <!-- Privacy Settings Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>security</mat-icon>
          Privacy Settings
        </h3>

        <mat-radio-group formControlName="privacyLevel" class="privacy-radio-group">
          <mat-radio-button *ngFor="let option of privacyOptions" 
                           [value]="option.value"
                           class="privacy-option">
            <div class="privacy-option-content">
              <div class="privacy-header">
                <mat-icon>{{ option.icon }}</mat-icon>
                <span class="privacy-label">{{ option.label }}</span>
              </div>
              <div class="privacy-description">{{ option.description }}</div>
            </div>
          </mat-radio-button>
        </mat-radio-group>
      </div>

      <!-- Permission Defaults Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>settings</mat-icon>
          Default Permissions
        </h3>
        <p class="section-description">
          Set default permissions for household members.
        </p>

        <div class="permissions-list">
          <mat-checkbox formControlName="allowMemberInvites" class="permission-checkbox">
            <div class="permission-content">
              <mat-icon>mail</mat-icon>
              <div class="permission-label">
                <div class="permission-title">Allow Member Invites</div>
                <div class="permission-description">Members can invite others to join the household</div>
              </div>
            </div>
          </mat-checkbox>

          <mat-checkbox formControlName="allowMemberEdits" class="permission-checkbox">
            <div class="permission-content">
              <mat-icon>edit</mat-icon>
              <div class="permission-label">
                <div class="permission-title">Allow Member Edits</div>
                <div class="permission-description">Members can edit household information</div>
              </div>
            </div>
          </mat-checkbox>

          <mat-checkbox formControlName="allowMemberUploads" class="permission-checkbox">
            <div class="permission-content">
              <mat-icon>cloud_upload</mat-icon>
              <div class="permission-label">
                <div class="permission-title">Allow Media Uploads</div>
                <div class="permission-description">Members can upload photos and documents</div>
              </div>
            </div>
          </mat-checkbox>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        <button mat-raised-button 
                type="button" 
                (click)="onCancel()"
                [disabled]="isSubmitting">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>
        
        <button mat-raised-button 
                color="primary" 
                type="submit"
                [disabled]="!isFormValid() || isSubmitting">
          <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
          {{ isEditMode ? 'Save Changes' : 'Create Household' }}
          <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
        </button>
      </div>

    </form>
  </mat-card-content>
</mat-card>

